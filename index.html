<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School RFID Attendance V3</title>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
    background-color: #f0f2f5;
}
.container {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}
h1, h2 {
    text-align: center;
    color: #2c3e50;
}
input, select {
    width: 100%;
    padding: 12px;
    margin: 5px 0;
    border-radius: 6px;
    border: 2px solid #e1e4e8;
}
button {
    width: 100%;
    padding: 14px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
}
button:hover { background: #45a049; }
.admin-box { border: 2px dashed #cbd5e0; background: #f8fafc; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media(max-width:600px){ .form-grid{grid-template-columns:1fr;} }

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}
th { background: #4CAF50; color: white; }
.profile-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}
.no-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #eee;
    display: flex;
    align-items: center;
    justify-content: center;
}
#status {
    margin-top: 10px;
    padding: 10px;
    text-align: center;
    display: none;
    font-weight: bold;
}
.success { background: #d4edda; color: #155724; }
.error { background: #f8d7da; color: #721c24; }
</style>
</head>

<body>

<div class="container">
<h1>üè´ Daily Attendance</h1>
<input type="text" id="attendanceInput" placeholder="Scan RFID tag">
<div id="status"></div>

<table id="attendanceTable">
<thead>
<tr>
<th>Photo</th>
<th>Time</th>
<th>Name</th>
<th>Grade</th>
<th>ID</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="container admin-box">
<h2>‚ûï Register Student</h2>

<div class="form-grid">
<input id="regName" placeholder="Full Name">
<select id="regGrade">
<option value="">Grade</option>
<option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
<option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
<option>Teacher</option>
</select>
</div>

<div class="form-grid">
<input id="regSubject" placeholder="Subject">
<select id="regGender">
<option value="">Gender</option>
<option>Male</option><option>Female</option><option>Other</option>
</select>
</div>

<select id="regPronouns">
<option value="">Pronouns</option>
<option>he/him</option>
<option>she/her</option>
<option>they/them</option>
</select>

<select id="regReligion">
<option value="">Religion</option>
<option>Buddhism</option>
<option>Christianity</option>
<option>Islam</option>
<option>Hinduism</option>
<option>Other</option>
<option>Prefer not to say</option>
</select>

<input type="file" id="regPhoto">
<input id="regTag" placeholder="Scan RFID to register">

<button onclick="registerStudent()">Save Student</button>

<hr>

<h2>‚úèÔ∏è Edit Student</h2>
<input id="editTag" placeholder="Scan RFID to edit">

<div class="form-grid">
<input id="editName" placeholder="Full Name">
<select id="editGrade">
<option value="">Grade</option>
<option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
<option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
<option>Teacher</option>
</select>
</div>

<div class="form-grid">
<input id="editSubject" placeholder="Subject">
<select id="editGender">
<option value="">Gender</option>
<option>Male</option><option>Female</option><option>Other</option>
</select>
</div>

<div class="form-grid">
<select id="editPronouns">
<option value="">Pronouns</option>
<option>he/him</option><option>she/her</option><option>they/them</option>
</select>
<select id="editReligion">
<option value="">Religion</option>
<option>Buddhism</option><option>Christianity</option><option>Islam</option>
<option>Hinduism</option><option>Other</option><option>Prefer not to say</option>
</select>
</div>

<button onclick="loadStudent()">Load</button>
<button onclick="updateStudent()" style="background:#2196F3;">Save Changes</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, doc,
  getDoc, updateDoc, onSnapshot, query, orderBy, limit, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let studentDirectory = {};

onSnapshot(collection(db,"students"), snap=>{
    studentDirectory = {};
    snap.forEach(d=>{
        studentDirectory[d.id]=d.data();
    });
});

const toBase64 = f => new Promise(r=>{
    const reader=new FileReader();
    reader.onload=()=>r(reader.result);
    reader.readAsDataURL(f);
});

window.registerStudent = async ()=>{
    const tag = regTag.value.trim();
    if(!tag) return alert("Scan RFID");

    let photo=null;
    if(regPhoto.files[0]) photo = await toBase64(regPhoto.files[0]);

    await setDoc(doc(db,"students",tag),{
        name: regName.value,
        grade: regGrade.value,
        subject: regSubject.value,
        gender: regGender.value,
        pronouns: regPronouns.value,
        religion: regReligion.value,
        photo,
        registeredAt: serverTimestamp()
    });
    alert("Student saved");
};

window.loadStudent = async ()=>{
    const snap = await getDoc(doc(db,"students",editTag.value));
    if(!snap.exists()) return alert("Not found");
    const d = snap.data();
    editName.value=d.name||"";
    editGrade.value=d.grade||"";
    editSubject.value=d.subject||"";
    editGender.value=d.gender||"";
    editPronouns.value=d.pronouns||"";
    editReligion.value=d.religion||"";
};

window.updateStudent = async ()=>{
    await updateDoc(doc(db,"students",editTag.value),{
        name: editName.value,
        grade: editGrade.value,
        subject: editSubject.value,
        gender: editGender.value,
        pronouns: editPronouns.value,
        religion: editReligion.value,
        updatedAt: serverTimestamp()
    });
    alert("Updated");
};

attendanceInput.addEventListener("keypress", async e=>{
    if(e.key==="Enter"){
        const id = attendanceInput.value.trim();
        const s = studentDirectory[id];
        await addDoc(collection(db,"attendance"),{
            tag_id:id,
            student_name:s?.name||"Unknown",
            student_grade:s?.grade||"",
            student_photo:s?.photo||null,
            timestamp:serverTimestamp()
        });
        attendanceInput.value="";
    }
});

const q = query(collection(db,"attendance"),orderBy("timestamp","desc"),limit(10));
onSnapshot(q,snap=>{
    const tb=document.querySelector("#attendanceTable tbody");
    tb.innerHTML="";
    snap.forEach(d=>{
        const x=d.data();
        tb.innerHTML+=`
        <tr>
        <td>${x.student_photo?`<img class="profile-pic" src="${x.student_photo}">`:`<div class="no-pic">?</div>`}</td>
        <td>${x.timestamp?.toDate().toLocaleTimeString()||""}</td>
        <td>${x.student_name}</td>
        <td>${x.student_grade}</td>
        <td>${x.tag_id}</td>
        </tr>`;
    });
});
</script>

</body>
</html>
