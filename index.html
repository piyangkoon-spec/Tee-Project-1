<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School RFID Attendance V3 (Fixed)</title>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
            background-color: #f0f2f5;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border-radius: 6px;
            border: 2px solid #e1e4e8;
            box-sizing: border-box; /* Fixes padding width issues */
        }
        button {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #45a049; }
        .admin-box { border: 2px dashed #cbd5e0; background: #f8fafc; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media(max-width:600px){ .form-grid{grid-template-columns:1fr;} }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        th { background: #4CAF50; color: white; }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .no-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }
        #status {
            margin-top: 10px;
            padding: 10px;
            text-align: center;
            display: none;
            font-weight: bold;
        }
    </style>
</head>

<body>

<div class="container">
    <h1>üè´ Daily Attendance</h1>
    <input type="text" id="attendanceInput" placeholder="Click here and scan RFID tag..." autofocus>
    <div id="status"></div>

    <table id="attendanceTable">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Time</th>
                <th>Name</th>
                <th>Grade</th>
                <th>ID</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="container admin-box">
    <h2>‚ûï Register Student</h2>

    <div class="form-grid">
        <input id="regName" placeholder="Full Name">
        <select id="regGrade">
            <option value="">Grade</option>
            <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
            <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
            <option>Teacher</option>
        </select>
    </div>

    <div class="form-grid">
        <input id="regSubject" placeholder="Subject">
        <select id="regGender">
            <option value="">Gender</option>
            <option>Male</option><option>Female</option><option>Other</option>
        </select>
    </div>

    <select id="regPronouns">
        <option value="">Pronouns</option>
        <option>he/him</option>
        <option>she/her</option>
        <option>they/them</option>
    </select>

    <select id="regReligion">
        <option value="">Religion</option>
        <option>Buddhism</option>
        <option>Christianity</option>
        <option>Islam</option>
        <option>Hinduism</option>
        <option>Other</option>
        <option>Prefer not to say</option>
    </select>

    <input type="file" id="regPhoto">
    <input id="regTag" placeholder="Scan RFID to register">

    <button id="btnRegister">Save Student</button> 

    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ccc;">

    <h2>‚úèÔ∏è Edit Student</h2>
    <input id="editTag" placeholder="Scan RFID to edit">

    <div class="form-grid">
        <input id="editName" placeholder="Full Name">
        <select id="editGrade">
            <option value="">Grade</option>
            <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
            <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
            <option>Teacher</option>
        </select>
    </div>

    <div class="form-grid">
        <input id="editSubject" placeholder="Subject">
        <select id="editGender">
            <option value="">Gender</option>
            <option>Male</option><option>Female</option><option>Other</option>
        </select>
    </div>

    <div class="form-grid">
        <select id="editPronouns">
            <option value="">Pronouns</option>
            <option>he/him</option><option>she/her</option><option>they/them</option>
        </select>
        <select id="editReligion">
            <option value="">Religion</option>
            <option>Buddhism</option><option>Christianity</option><option>Islam</option>
            <option>Hinduism</option><option>Other</option><option>Prefer not to say</option>
        </select>
    </div>

    <button id="btnLoad">Load Info</button>
    <button id="btnUpdate" style="background:#2196F3;">Save Changes</button>
</div>

<script type="module">
    // ---------------------------------------------------------
    // 1. FIREBASE IMPORTS & SETUP
    // ---------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getFirestore, collection, addDoc, setDoc, doc,
        getDoc, updateDoc, onSnapshot, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // !!! IMPORTANT: REPLACE THESE VALUES WITH YOUR FIREBASE KEYS !!!
    const firebaseConfig = {
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAphH-GPUsgbPiWGQgFXOiiLTaMLEc80qs",
  authDomain: "rfid-project-26d4b.firebaseapp.com",
  projectId: "rfid-project-26d4b",
  storageBucket: "rfid-project-26d4b.firebasestorage.app",
  messagingSenderId: "943488412381",
  appId: "1:943488412381:web:b8f68b506744290f658934",
  measurementId: "G-H3BYERRXV7"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------------------------------------------------------
    // 2. HELPER FUNCTIONS
    // ---------------------------------------------------------
    
    // Convert file to Base64 string for storage
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    // Cache students in memory to avoid reading DB on every scan
    let studentDirectory = {};
    onSnapshot(collection(db, "students"), snapshot => {
        studentDirectory = {};
        snapshot.forEach(doc => {
            studentDirectory[doc.id] = doc.data();
        });
        console.log("Student directory updated:", Object.keys(studentDirectory).length + " students");
    });

    // ---------------------------------------------------------
    // 3. REGISTER NEW STUDENT
    // ---------------------------------------------------------
    document.getElementById('btnRegister').addEventListener('click', async () => {
        const tag = document.getElementById('regTag').value.trim();
        const fileInput = document.getElementById('regPhoto');
        
        if (!tag) return alert("Please scan an RFID tag first!");

        try {
            let photo = null;
            if (fileInput.files.length > 0) {
                photo = await toBase64(fileInput.files[0]);
            }

            await setDoc(doc(db, "students", tag), {
                name: document.getElementById('regName').value,
                grade: document.getElementById('regGrade').value,
                subject: document.getElementById('regSubject').value,
                gender: document.getElementById('regGender').value,
                pronouns: document.getElementById('regPronouns').value,
                religion: document.getElementById('regReligion').value,
                photo: photo,
                registeredAt: serverTimestamp()
            });

            alert("‚úÖ Student Registered Successfully!");
            
            // Clear inputs
            document.getElementById('regTag').value = "";
            document.getElementById('regName').value = "";
            fileInput.value = "";
        } catch (e) {
            console.error(e);
            alert("Error saving: " + e.message);
        }
    });

    // ---------------------------------------------------------
    // 4. LOAD & EDIT STUDENT
    // ---------------------------------------------------------
    document.getElementById('btnLoad').addEventListener('click', async () => {
        const tag = document.getElementById('editTag').value.trim();
        if(!tag) return alert("Scan RFID tag to load");

        try {
            const snap = await getDoc(doc(db, "students", tag));
            if (!snap.exists()) return alert("Student not found!");

            const d = snap.data();
            document.getElementById('editName').value = d.name || "";
            document.getElementById('editGrade').value = d.grade || "";
            document.getElementById('editSubject').value = d.subject || "";
            document.getElementById('editGender').value = d.gender || "";
            document.getElementById('editPronouns').value = d.pronouns || "";
            document.getElementById('editReligion').value = d.religion || "";
        } catch (e) {
            console.error(e);
            alert("Error loading: " + e.message);
        }
    });

    document.getElementById('btnUpdate').addEventListener('click', async () => {
        const tag = document.getElementById('editTag').value.trim();
        if(!tag) return alert("Scan RFID tag to update");

        try {
            await updateDoc(doc(db, "students", tag), {
                name: document.getElementById('editName').value,
                grade: document.getElementById('editGrade').value,
                subject: document.getElementById('editSubject').value,
                gender: document.getElementById('editGender').value,
                pronouns: document.getElementById('editPronouns').value,
                religion: document.getElementById('editReligion').value,
                updatedAt: serverTimestamp()
            });
            alert("‚úÖ Student Updated!");
        } catch (e) {
            console.error(e);
            alert("Error updating: " + e.message);
        }
    });

    // ---------------------------------------------------------
    // 5. ATTENDANCE SYSTEM
    // ---------------------------------------------------------
    const attendanceInput = document.getElementById('attendanceInput');
    
    attendanceInput.addEventListener("keypress", async (e) => {
        if (e.key === "Enter") {
            const id = attendanceInput.value.trim();
            if(!id) return;

            const s = studentDirectory[id]; // Look up in local cache

            try {
                await addDoc(collection(db, "attendance"), {
                    tag_id: id,
                    student_name: s?.name || "Unknown Tag",
                    student_grade: s?.grade || "N/A",
                    student_photo: s?.photo || null,
                    timestamp: serverTimestamp()
                });
                console.log("Attendance recorded for:", id);
            } catch (err) {
                console.error("Attendance failed:", err);
            }

            // Clear input for next scan
            attendanceInput.value = "";
        }
    });

    // ---------------------------------------------------------
    // 6. LIVE TABLE UPDATE
    // ---------------------------------------------------------
    const q = query(collection(db, "attendance"), orderBy("timestamp", "desc"), limit(10));
    
    onSnapshot(q, (snapshot) => {
        const tbody = document.querySelector("#attendanceTable tbody");
        tbody.innerHTML = ""; // Clear table
        
        snapshot.forEach(doc => {
            const data = doc.data();
            const timeString = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : "Just now";
            
            // Handle photo display
            let photoHtml = '<div class="no-pic">?</div>';
            if(data.student_photo){
                photoHtml = `<img class="profile-pic" src="${data.student_photo}" alt="Student">`;
            }

            const row = `
                <tr>
                    <td>${photoHtml}</td>
                    <td>${timeString}</td>
                    <td>${data.student_name}</td>
                    <td>${data.student_grade}</td>
                    <td>${data.tag_id}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    });

</script>

</body>
</html>

